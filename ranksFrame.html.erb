<!DOCTYPE html>
<html lang="en-US">
	<head>
		<%= stylesheet_link_tag "teams.css" %>
		<script>
			var recentData;
			function messageListener(event){
		        //console.log("MESASGE RECEIVED");
		        //console.log(event.origin);
		        try{
			    	document.getElementById("ifResultsPane").parentNode.style.background = "";
			        eval(event.data.userAlgorithm);
			        if(event.data.rawData !== null){
				        recentData = remap(event.data.rawData);
			        }
			        displayResults(main(recentData), window.location.protocol + "//" + window.location.host);
			    }catch(err){
			    	console.log(err);
					document.getElementById("ifResultsPane").innerHTML = "";
			    	document.getElementById("ifResultsPane").parentNode.style.background = "#AA0000";
		            document.getElementById("ifResultsPane").innerHTML = "<p>" +  err.toString() + "</br>" + "Check the JS console!</p>";
			    }
		    }

		    function buildRankBox(rank, teamObj, urlheader){

				var rankContainer = document.createElement('div');
				rankContainer.className = 'rankContainer';
				rankContainer.style.height = '40px';
				if(rankContainer.addEventListener){
		             rankContainer.addEventListener("click", function() {
		             	console.log(rank);
		             	console.log(teamObj);
		             });
		        } else {
		        	rankContainer.addEventListener("click", function() {
		             	console.log(teamObj);
		            });
		        };
		        if(rank + 1 > 25){
		        	rankContainer.style.opacity = .3;
		        }
	            document.getElementById("ifResultsPane").appendChild(rankContainer);

				var rankNum = document.createElement('p');
				rankNum.innerText = (rank+1);
				rankNum.className = 'rankNumber';
	            rankContainer.appendChild(rankNum); /* Append before calcultaing height */

	            var myHeight = rankNum.getBoundingClientRect().height;
	            var containerHeight = rankNum.getBoundingClientRect().height;

				rankNum.style.top = -(containerHeight - myHeight/2) + 'px';

	            var teamCont = document.createElement('div');
	            teamCont.className = 'teamBox';
	            teamCont.style.height = '40px';
	            var box = rankNum.getBoundingClientRect();
	            var width = box.right - box.left;
	            teamCont.style.left =  (width + 10) + 'px';

	            var logo = document.createElement('img');
	            logo.src =  urlheader + '/assets/team_logos/' + teamObj.team_code + '.png';
	            logo.width='40';
	            teamCont.appendChild(logo);
	            logo.className = 'teamBoxLogo'
	            logo.top = (teamCont.getBoundingClientRect().height - logo.getBoundingClientRect().height)/2 + 'px';

	            var displayName = document.createElement('p');
	            displayName.innerText = teamObj.name;
	            displayName.className = 'teamBoxName'
	            teamCont.appendChild(displayName);

	            rankContainer.appendChild(teamCont);
	            return teamCont;
	    	}

			function displayResults(toDisplay, urlheader){
				//console.log("Runnnig");
				document.getElementById("ifResultsPane").innerHTML = "";
		        for(var i = 0; i < 50; i++){ //toDisplay.length; i++){
					buildRankBox(i, toDisplay[i], urlheader);
		            //rankContainer.appendChild(teamCont);
		            //teamCont.innerHTML += "<p>" + (i+1) + ': ' + toDisplay[i].name + '</p>'  ;//+ '<img alt="maybe" src="http://do-book.stanford.edu:3000/assets/team_logos/' + toDisplay[i].team_code + '.png">';

		        }
    		}


			function runFunction(urlheader){
		        window.onload = function(){
		            if(window.addEventListener){
		                addEventListener("message", messageListener, false);
		            } else{
		                attachEvent("onmessage", listener);
		            }
		            //console.log(rankArray);
		            /*
		            var rankArray = remap(rankArray);
		            try{
		                var toDisplay = main(rankArray);
		                displayResults(toDisplay, urlheader);
		            }
		            catch(err){
		                document.getElementById("resultsPane").parentNode.style.background = "#AA0000";
		                document.getElementById("resultsPane").innerHTML = "<p>" +  err.toString() + "</br>" + "Check the JS console!</p>";
		            }
		            */
		        };
		    }

		    function remap(jsonData){
			    var namesMap = {};
			    for(var i = 0; i < jsonData.length; i++){
			        namesMap[jsonData[i].name] = jsonData[i];
			    }

			    var gameMap = {};
			    for(var i = 0; i < jsonData.length; i++){
			        var team = jsonData[i];
			        for(var j = 0; j < jsonData[i].schedule.length; j++){
			            var game = team.schedule[j];
			            game.opp = namesMap[game.opp];
			            game.team = jsonData[i];
			            var mirror = gameMap[game.game_code];
			            if(!mirror){
			                gameMap[game.game_code] = game;
			            }
			            else{
			                game.opp_game = mirror;
			                mirror.opp_game = game;
			            }
			        }
			    }
			    return jsonData;
			}
	        window.onload = function(){
	            if(window.addEventListener){
	                addEventListener("message", messageListener, false);
	            } else{
	                attachEvent("onmessage", listener);
	            }
	            //console.log(rankArray);
	        }
		</script>
	</head>
	<body>
		<div class="rankingsWrapper"></div>
	</body>
</html>





