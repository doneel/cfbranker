$(document).ready(function(){
    if(window.addEventListener){
		addEventListener("message", getMessage, false);
    } else{
		attachEvent("onmessage", getMessage);
    }
    ranker = new Ranker(document.querySelector('.rankings'), null, null, buildTeamTile, remap);

    $('.banner').css('display', 'none');

});

function getMessage(event){
        if(event.data.share == true){
            openResultsTab(event.data);
            return;
        }
	ranker.updateCode(event.data.newCode);
	ranker.updateData(event.data.rawData);
        ranker.run();
}

function openResultsTab(resultsData){
    var weekDisplayStr;
    if (resultsData.week == "Bowl"){
        weekDisplayStr = "Final Rankings";
    }else{
        weekDisplayStr = "Week " + resultsData.week;
    }
    var yourDOCTYPE = "<!DOCTYPE html>";
    var printPreview = window.open('about:blank', '_');
    var printDocument = printPreview.document;
    printDocument.open();
    printDocument.write(yourDOCTYPE+
            "<html>"+
            "<div class=\"resultsWrapper\">" + 
            "<div class=\"resultsWeekLabel\">" + resultsData.season + " " + weekDisplayStr + "</div>" + 
            "<div> "+
            document.documentElement.innerHTML+ "</div></div>"+
       "</html>");
    printDocument.close();
}

function buildTeamTile(rank, team){


    var teamTile = document.createElement('div');
    teamTile.className = 'teamTile';
    var context = this;
    teamTile.onclick = function(){
        console.log(team);
    };

    var numberingDiv = document.createElement('div');
    numberingDiv.className = 'numberingDiv';
    teamTile.appendChild(numberingDiv);

    var rankNumber = document.createElement('p');
    rankNumber.className = 'rankNumber';
    rankNumber.innerHTML = rank + 1;
    numberingDiv.appendChild(rankNumber);

    var teamSide = document.createElement('div');
    teamSide.className = 'teamSide';
    teamTile.appendChild(teamSide);

    
    var teamLogoContainer = document.createElement('div');
    teamLogoContainer.className = ' teamLogo';

    var teamLogo =  document.createElement('div');
    teamLogo.className += ' team-logo';
    teamLogo.className += ' team' + team.team_code;

    teamLogoContainer.appendChild(teamLogo);

    teamSide.appendChild(teamLogoContainer);

    var teamName = document.createElement('p');
    teamName.className = 'teamName';
    teamName.innerHTML = team.name;
    teamSide.appendChild(teamName);

    return teamTile;

}


function remap(jsonData){
    var namesMap = {};
    for(var k = 0; k < jsonData.length; k++){
        namesMap[jsonData[k].name] = jsonData[k];
    }

    var gameMap = {};
    for(var i = 0; i < jsonData.length; i++){
        var team = jsonData[i];
        for(var j = 0; j < jsonData[i].schedule.length; j++){
            var game = team.schedule[j];
            game.opp = namesMap[game.opp];
            game.team = jsonData[i];
            var mirror = gameMap[game.game_code];
            if(!mirror){
                gameMap[game.game_code] = game;
            }
            else{
                game.opp_game = mirror;
                mirror.opp_game = game;
            }
        }
    }

    return jsonData;
}

